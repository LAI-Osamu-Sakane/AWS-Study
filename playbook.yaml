- name: Install OpenJDK 21 and Git on Amazon Linux 2023
  hosts: ec2
  become: true
  tasks:
    - name: Install OpenJDK 21 (Amazon Corretto)
      yum:
        name: java-21-amazon-corretto-devel
        state: present

    - name: Set JAVA_HOME and update PATH
      copy:
        dest: /etc/profile.d/java.sh
        content: |
          export JAVA_HOME=/usr/lib/jvm/java-21-amazon-corretto
          export PATH=$JAVA_HOME/bin:$PATH
        mode: '0755'

    - name: Install git
      yum:
        name: git
        state: present

    - name: Import MySQL GPG key
      rpm_key:
        state: present
        key: https://repo.mysql.com/RPM-GPG-KEY-mysql-2023

    # - name: Download MySQL Yum Repository RPM with retries
    #   block:
    #     - name: Try to download MySQL repo RPM
    #       get_url:
    #         url: https://dev.mysql.com/get/mysql80-community-release-el9-1.noarch.rpm
    #         dest: /tmp/mysql80-community-release.rpm
    #         timeout: 30
    #       register: result
    #       until: result is succeeded
    #       retries: 3
    #       delay: 5

    # - name: Install MySQL Yum Repository
    #   yum:
    #     name: /tmp/mysql80-community-release.rpm
    #     state: present

    # - name: Disable default MySQL module (to avoid conflict)
    #   command: dnf module disable mysql -y
    #   args:
    #     warn: false

    # - name: Install MySQL client only
    #   yum:
    #     name: mysql-community-client
    #     state: present
    - name: Install MySQL 8.0 client from default Amazon Linux repo
      dnf:
        name: mysql-client
        state: present